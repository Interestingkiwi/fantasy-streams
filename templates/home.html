<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - H2H Fantasy Optimizer</title>
    <script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-gray-900 text-white">

    <div id="help-modal" class="modal">
        <div class="modal-content bg-gray-800 text-white">
            <span class="close-button">&times;</span>
            <h2 id="modal-title" class="text-xl font-bold mb-2">Help</h2>
            <p id="modal-text">If this is your first time here, please go to League Database and initialize a database for your league. Data collected is restricted to yahoo fantasy team information, and not personal yahoo account data. To see all data collected, you can go to the Download DB tab to get a copy of everything collected.</p>
        </div>
    </div>


    <div class="p-4">
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                    League Home
                </h1>
                <span class="help-icon" data-title="Help" data-text="If this is your first time here, please go to League Database and initialize a database for your league. Data collected is restricted to yahoo fantasy team information, and not personal yahoo account data. To see all data collected, you can go to the Download DB tab to get a copy of everything collected.">?</span>
                <main class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-2 w-fit">
                    <p id="timestamp-text" class="text-gray-400 text-xs">Loading league data...</p>
                    <p class="text-gray-400 text-xs">Projection data is sourced by reddit user: <a href="https://www.reddit.com/r/fantasyhockey/comments/1n1wsqc/dtz_20252026_nhl_projections/" target="_blank" class="text-blue-400 hover:underline">Datsyuktozetterberg</a></p>
                </main>

                <div id="dropdown-container" class="flex items-start gap-6">
                      <div class="flex flex-col gap-2">
                          <div class="flex items-center gap-2 justify-end">
                              <label for="week-select" class="text-sm font-medium text-gray-300">Fantasy Week:</label>
                              <select id="week-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-48 p-2">
                                  <option selected>Choose a week</option>
                              </select>
                          </div>
                          <div class="flex items-center gap-2 justify-end">
                              <label for="your-team-select" class="text-sm font-medium text-gray-300">Your Team:</label>
                              <select id="your-team-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-48 p-2">
                                  <option selected>Choose your team</option>
                              </select>
                          </div>
                      </div>

                      <div class="flex flex-col gap-2">
                          <div class="flex items-center gap-2 justify-end">
                              <label for="stat-sourcing-select" class="text-sm font-medium text-gray-300">Stat Sourcing:</label>
                              <select id="stat-sourcing-select" class="dropdown-select bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-48 p-2">
                              </select>
                          </div>
                          <div class="flex justify-end">
                               <div class="flex items-center gap-2 bg-gray-800 py-1.5 px-4 rounded-lg border border-gray-600 shadow-sm w-48 justify-center">
                                  <input type="checkbox" id="global-show-raw-data" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                                  <label for="global-show-raw-data" class="text-sm font-medium text-gray-300 cursor-pointer select-none">Show Raw Data</label>
                              </div>
                          </div>
                      </div>
                </div>
            </div>

            <div class="flex flex-col gap-2 items-end">
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Logout
                </button>

                {% if session.get('dev_mode') and dev_leagues %}
                <div class="flex items-center gap-2 mt-2 bg-red-900/30 p-2 rounded border border-red-500/50">
                    <label for="dev-league-select" class="text-xs font-bold text-red-400 uppercase tracking-wider">Dev Switch:</label>
                    <select id="dev-league-select" class="bg-gray-800 text-white text-xs border border-gray-600 rounded px-2 py-1 focus:ring-red-500 focus:border-red-500">
                        {% for lid in dev_leagues %}
                            <option value="{{ lid }}" {% if lid|string == session['league_id']|string %}selected{% endif %}>
                                {{ lid }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <script>
                    // Inline script to handle the Dev Switch logic
                    document.addEventListener('DOMContentLoaded', () => {
                        const devSelect = document.getElementById('dev-league-select');

                        if (devSelect) {
                            devSelect.addEventListener('change', async (e) => {
                                const newLeagueId = e.target.value;

                                // Disable to prevent multiple clicks
                                devSelect.disabled = true;
                                devSelect.classList.add('opacity-50');

                                try {
                                    const response = await fetch('/api/dev/switch_league', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ league_id: newLeagueId })
                                    });

                                    if (response.ok) {
                                        // Reload page to refresh data context
                                        window.location.reload();
                                    } else {
                                        alert('Failed to switch league.');
                                        devSelect.disabled = false;
                                        devSelect.classList.remove('opacity-50');
                                    }
                                } catch (err) {
                                    console.error('Dev switch error:', err);
                                    alert('Error switching league.');
                                    devSelect.disabled = false;
                                }
                            });
                        }
                    });
                </script>
                {% endif %}
            </div>
        </div>

        <div id="toggle-buttons-container" class="flex items-center gap-2 mb-4">
            <button data-page="league-database" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                League Database
            </button>
            <button data-page="matchup" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Matchup
            </button>
            <button data-page="lineups" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Lineups
            </button>
            <button data-page="free-agents" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Free Agents
            </button>
            <button data-page="goalie-planning" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Goalie Planning
            </button>
            <button data-page="trade-helper" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Trade Helper
            </button>
            <button data-page="schedules" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Schedule Insights
            </button>
            <button data-page="season-history" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                Season History
            </button>

            <script>
                const isDevelopment = true; // Set to false for production
                if (isDevelopment) {
                    document.write(`
                        <button data-page="db" class="toggle-btn px-4 py-2 text-sm font-medium rounded-lg transition">
                            Download DB
                        </button>
                    `);
                }
            </script>
        </div>

        <div id="page-content" class="bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[60vh]">
            </div>
    </div>
    <script>
        // Pass Python data to JS from Flask
        // 'auto_update' is passed from app.py
        // We use |tojson|safe to render it as a valid JS object
        window.autoUpdateInfo = {{ auto_update | tojson | safe }};
    </script>

    <script src="{{ url_for('static', filename='home.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pageContent = document.getElementById('page-content');
            let currentPageScript = null; // Keep track of the current page's script

            // Define the classes for each state
            const activeClasses = ['bg-blue-600', 'text-white'];
            const inactiveClasses = ['bg-gray-700', 'text-gray-300', 'hover:bg-gray-600'];

            function setButtonState(button, isActive) {
                if (isActive) {
                    button.classList.remove(...inactiveClasses);
                    button.classList.add(...activeClasses);
                } else {
                    button.classList.remove(...activeClasses);
                    button.classList.add(...inactiveClasses);
                }
            }

            async function loadPage(pageName) {
                try {
                    // Remove the old page's script to prevent duplicate event listeners
                    if (currentPageScript) {
                        currentPageScript.remove();
                        currentPageScript = null;
                    }

                    // Add a loading state
                    pageContent.innerHTML = `<p class="text-gray-400">Loading ${pageName.replace(/-/g, ' ')}...</p>`;

                    const response = await fetch(`/pages/${pageName}.html`);
                    if (!response.ok) {
                        throw new Error(`Page not found: ${pageName}.html`);
                    }
                    const content = await response.text();
                    pageContent.innerHTML = content;

                    // After setting the innerHTML, find and execute the script
                    const scriptElement = pageContent.querySelector('script');
                    if (scriptElement) {
                        const newScript = document.createElement('script');
                        if (scriptElement.src) {
                            newScript.src = scriptElement.src;
                            newScript.onload = () => console.log(`${pageName}.js loaded from src`);
                            document.body.appendChild(newScript);
                        } else {
                            newScript.textContent = scriptElement.textContent; // Use textContent for security
                            document.body.appendChild(newScript);
                        }
                        currentPageScript = newScript; // Store the new script
                        scriptElement.remove(); // Remove the original script from the page content
                    }

                } catch (error) {
                    console.error('Error loading page:', error);
                    pageContent.innerHTML = `<p class="text-red-400">Error loading page content. Check the console for details.</p>`;
                }
            }

            // This needs to be done inside DOMContentLoaded to ensure all buttons exist
            const allToggleButtons = document.querySelectorAll('.toggle-btn');

            allToggleButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const pageToLoad = button.getAttribute('data-page');

                    // Set all buttons to inactive first
                    allToggleButtons.forEach(btn => setButtonState(btn, false));

                    // Then set the clicked button to active
                    setButtonState(button, true);

                    // Load the page content
                    loadPage(pageToLoad);
                });
            });

            // Initial load
            const firstButton = allToggleButtons[0];
            if (firstButton) {
                allToggleButtons.forEach((btn, index) => {
                    setButtonState(btn, index === 0);
                });
                loadPage(firstButton.getAttribute('data-page'));
            }

            // Modal script
            const modal = document.getElementById('help-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const closeButton = document.querySelector('.close-button');

            // Function to open the modal with specific content
            function openModal(title, text) {
                modalTitle.textContent = title;
                modalText.textContent = text;
                modal.style.display = 'block';
            }

            // Close the modal
            closeButton.onclick = () => {
                modal.style.display = 'none';
            }

            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // Attach event listener to a parent element (delegation)
            document.body.addEventListener('click', (event) => {
                if (event.target.classList.contains('help-icon')) {
                    const title = event.target.dataset.title || 'Help';
                    const text = event.target.dataset.text || 'Placeholder help text.';
                    openModal(title, text);
                }
            });
        });
    </script>

    <div id="global-cat-rank-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden" style="backdrop-filter: blur(2px);">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm relative border border-gray-700">
            <button id="global-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            <h3 id="global-modal-title" class="text-xl font-bold text-white mb-4">Category Breakdown</h3>
            <div id="global-modal-content" class="text-gray-300"></div>
        </div>
    </div>
</body>
</html>
